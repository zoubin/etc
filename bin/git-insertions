#!/usr/bin/env bash

# 输入应当是两个 revision，参考 git help diff 中的信息
# git insertions v1 v2 -- dir
# 输出：新增行数、email

# git diff 可拿到两个版本之间的文件改动信息，只需要考虑新增的行数，通过行范围还可以进一步通过 git blame 进行筛选（去掉粘贴的行），然后可以按人计算

extract_diff_info() {
  awk '
    /^\+\+\+ / {
      if (NR > 1) printf("\n");
      file = substr($2, 3);
      printf("%s", file);
    }
    /^@@ / {
      n += 1;
      if (n > 2000) {
        n = 0
        printf("\n%s", file);
      }
      i = index($3, ",");
      if (i > 0) {
        j = substr($3, i + 1);
        if (j != "0") printf(" -L %s,+%s", substr($3, 2, i - 2), j);
      } else {
        printf(" -L %s,+1", substr($3, 2));
      }
    }
  '\
  | awk '/ -L / {print $0}'
}

extract_blame_email() {
  awk '/[^)]+\)[ ]+[^ ]+/ {
    if (substr($2, 1, 1) == "(") {
      print substr($2, 3, length($2) -3);
    }
  }'
}

git diff -b -w -U0 "$@"\
  | extract_diff_info\
  | xargs -L 1 git blame -e $2\
  | extract_blame_email\
  | sort | uniq -c | sort -n -r\
  | sed -e 's/^[ ]*//' -e $'s/ /\t/'\
  | awk '{ print } END { if (NR == 0) print "0\t-" }'
